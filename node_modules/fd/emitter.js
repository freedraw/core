var asap = require('asap')
var slice = [].slice

function emitter(object) {

  object.on = function(name, fn, context, once) {
    var map = this.listeners || (this.listeners = Object.create(null))
    var list = map[name] || (map[name] = [])
    list.push({fn: fn, context: context, once: !!once})
    return this
  }

  object.once = function(name, fn, context) {
    this.on(name, fn, context, true)
    return this
  }

  object.unlisten = function(name, fn, context) {
    var map = this.listeners
    if (!map) return this
    var list = map[name]
    if (!list) return this
    for (var i = list.length; i--;) {
      var l = list[i]
      if (l.fn === fn && l.context === context) {
        list.splice(i, 1)
      }
    }
    return this
  }

  object.emit = function(name, data) {
    var map = this.listeners
    if (!map) return this
    var list = map[name]
    if (!list) return this
    list.forEach(function(l) {
      asap(l.fn.bind(l.context, data))
    })
    return this
  }

  return object
}

emitter.property = function(object, name) {
  var data = '_' + name
  var event = name + 'Change'
  Object.defineProperty(object, name, {
    get: function() {return this[data]},
    set: function(value) {
      this[data] = value
      this.emit(event)
    }
  })
}

module.exports = emitter
